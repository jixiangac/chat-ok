# Change: 2026年1月多功能增强

## Why

本次变更旨在提升用户体验和系统完整性：
1. **通用聊天增强**：AI 推荐任务时能自动跳转创建流程，提高转化率
2. **清单详情页重构**：移除不适合清单类型的进度组件，采用更直观的清单列表交互
3. **归档历史完善**：让用户能查看已归档任务的完整详情，而非简单的列表卡片
4. **纪念日体验优化**：采用步骤式创建流程，与任务创建保持一致的交互范式
5. **任务类型灵活性**：支持主线转支线，满足用户调整任务优先级的需求
6. **奖励机制修复**：修复打卡奖励超限后仍发放的 BUG

## What Changes

### 1. 通用聊天 - 任务卡片自动打开创建界面
- **前提**：用户需明确表达创建任务意图，AI 不得擅自推荐任务配置
- 当用户明确要求创建任务时，AI（general 角色）输出 TASK_CONFIG 结构化数据
- 用户点击「使用此配置」后自动打开 CreateTaskModal
- 预填 AI 推荐的配置参数
- 复用现有 taskCreator 角色的逻辑

### 2. 清单类详情页重构
- **移除**：WaterCupProgress 等水位进度组件（不适合清单类型）
- **新增**：当前周期清单事项列表，直接打钩完成
- **保留**：周期进展卡片、记录入口、计划入口
- **新增**：「添加更多」按钮 - 查看非当前周期/未完成的清单项，单个添加（消耗 1 灵玉/项）
- **新增**：「延后」操作 - 将清单项移除到下一周期（消耗 2 灵玉/项）

### 3. 归档历史功能增强
- 点击归档列表中的任务，打开完整的 GoalDetailModal
- 详情页为**只读模式**：隐藏打卡按钮、编辑按钮
- 可查看：周期计划、周期历史、所有详情数据

### 4. 纪念日新增界面优化
- 采用步骤式设计（参考 CreateTaskModal）
- 第 1 步：名称 + 日期
- 第 2 步：图片背景选择
- 第 3 步：预览面板
- 固定消耗 **50 灵玉**

### 5. 主线任务转支线任务
- 在详情页右上角「更多」菜单新增「转为支线」选项
- 点击后弹窗二次确认，UI 风格类似支线区域的弹窗
- 消耗固定 **50 灵玉**
- 自动转为 sidelineA 类型
- 任务数据（周期、进度等）完全保留，仅改变 type 字段

### 6. 打卡奖励上限 BUG 修复
- 每个任务有每日灵玉、修为奖励上限
- 当日已发放奖励达到上限后，**停止发放**但**允许继续打卡**
- 需在奖励发放逻辑中增加上限检查

### 7. 灵玉明细页面手势返回 BUG 修复
- 灵玉明细页面当前有自己实现的手势逻辑，但效果与设置子页面不一致
- 需要改用 `useSwipeBack` hook 统一手势行为
- 确保滑动时有实时跟手反馈、回弹效果等一致体验

## Impact

- **Affected specs**: 
  - `agent-chat` - 新增自动打开创建任务逻辑
  - `detail-panel` - 清单类型布局重构、归档只读模式、转支线菜单
  - `memorial-panel` - 步骤式创建流程
  - `spirit-jade-system` - 新增消耗场景（清单操作、纪念日、转支线）、奖励上限修复、灵玉页面手势修复

- **Affected code**:
  - `src/pages/dc/agent/` - AgentChat general 角色处理
  - `src/pages/dc/panels/detail/` - 清单布局、只读模式、转支线
  - `src/pages/dc/panels/memorial/` - 步骤式创建
  - `src/pages/dc/utils/spiritJadeCalculator.ts` - 奖励上限逻辑
  - `src/pages/dc/contexts/TaskContext/` - 主线转支线
  - `src/pages/dc/viewmodel/SpiritJadePage/` - 手势返回修复
