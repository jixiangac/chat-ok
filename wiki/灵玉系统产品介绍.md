# 灵玉系统产品介绍

> 灵玉是 DC（修炼场）应用中的核心虚拟货币系统，用于激励用户完成任务、管理日常计划，同时约束资源滥用。

---

## 目录

1. [什么是灵玉](#什么是灵玉)
2. [灵玉获取方式](#灵玉获取方式)
3. [灵玉消耗场景](#灵玉消耗场景)
4. [积分上限机制](#积分上限机制)
5. [折扣与优惠](#折扣与优惠)
6. [灵玉与修为的关系](#灵玉与修为的关系)
7. [数据查看与管理](#数据查看与管理)

---

## 什么是灵玉

**灵玉**是应用内的虚拟货币，采用修仙主题设计。它具有以下特点：

| 属性 | 说明 |
|------|------|
| 初始赠送 | 新用户注册后自动获得 **1000 灵玉** |
| 用途 | 创建任务、刷新清单、AI 对话等功能消耗 |
| 获取方式 | 完成任务打卡、达成周期目标等途径获得 |
| 存储位置 | 本地存储（localStorage） |

### 灵玉数据结构

```typescript
interface SpiritJadeData {
  balance: number;       // 当前余额
  totalEarned: number;   // 累计获得
  totalSpent: number;    // 累计消耗
  lastUpdatedAt: string; // 最后更新时间
  createdAt: string;     // 创建时间
}
```

---

## 灵玉获取方式

### 1. 任务打卡奖励

每次完成任务打卡可获得灵玉奖励，奖励数量受以下因素影响：

#### 基础配置
- **基础灵玉**：20 / 天
- **基础修为**：10 / 天

#### 打卡类型系数

| 打卡类型 | 系数 | 说明 |
|---------|------|------|
| 时长类（DURATION） | 1.15 | +15% 加成 |
| 次数类（TIMES） | 1.0 | 无加成 |
| 数量类（QUANTITY） | 1.10 | +10% 加成 |

#### 任务类型系数

| 任务类型 | 系数 | 说明 |
|---------|------|------|
| 主线任务（mainline） | 2.0 | +100% 加成（双倍） |
| 支线任务 A/B | 1.0 | 无加成 |

#### 计算公式

```
每日灵玉上限 = 20 × 打卡类型系数 × 任务类型系数
每日修为上限 = 10 × 打卡类型系数 × 任务类型系数
```

**示例**：主线任务 + 时长打卡
- 灵玉上限 = 20 × 1.15 × 2.0 = 46 灵玉/天
- 修为上限 = 10 × 1.15 × 2.0 = 23 修为/天

---

### 2. 今日必完成加成

将任务标记为「今日必完成」后，完成该任务可获得 **+15%** 的额外奖励。

```
实际奖励 = 基础奖励 × 1.15
```

---

### 3. 周期完成 100% 奖励

当一个任务周期（如每日、每周）达成 100% 完成率时，额外获得该周期积分上限的 **10%** 作为奖励。

```
周期完成奖励 = 周期积分上限 × 0.10
```

---

### 4. 一日清单完成奖励

完成当天所有一日清单任务后，获得额外奖励：

#### 基础奖励
- 基础灵玉：10
- 基础修为：10

#### 任务数量加成

| 任务数量 | 加成比例 |
|---------|---------|
| > 10 个任务 | +25% |
| > 8 个任务 | +20% |
| > 5 个任务 | +15% |

---

### 5. 归档奖励

任务归档（完结）时发放的一次性奖励：

```
归档奖励 = 每日上限 × 2 × 完成率
```

**限制条件**：完成率 < 30% 时不发放奖励

---

## 灵玉消耗场景

### 消耗明细表

| 消耗场景 | 消耗数量 | 说明 |
|---------|---------|------|
| 创建支线任务 | 200 ~ 500 灵玉 | 动态计算，基于任务收益 |
| 创建主线任务 | 500 ~ 1000 灵玉 | 动态计算，基于任务收益 |
| 刷新一日清单 | 25 灵玉 | 固定消耗 |
| 延后清单项到下周期 | 2 灵玉 | 每项固定消耗 |
| 加入当前周期 | 1 灵玉 | 每项固定消耗 |
| 创建纪念日 | 50 灵玉 | 固定消耗 |
| 主线转支线任务 | 50 灵玉 | 固定消耗 |
| AI 对话 | 5 灵玉 / 3000 tokens | 按 token 累计消耗 |

---

### 1. 创建任务消耗

任务创建费用基于任务完成后可获得的灵玉数量动态计算：

#### 主线任务
```
消耗 = 预计完成灵玉 × 0.2
结果取整到十位
范围限制：500 ~ 1000 灵玉
```

#### 支线任务
```
消耗 = 预计完成灵玉 × 0.15
结果取整到十位
范围限制：200 ~ 500 灵玉
```

---

### 2. 刷新一日清单

每次刷新一日清单固定消耗 **25 灵玉**。

---

### 3. 清单项操作

| 操作 | 消耗 |
|------|------|
| 延后到下周期 | 2 灵玉/项 |
| 加入当前周期 | 1 灵玉/项 |

---

### 4. 创建纪念日

创建新的纪念日固定消耗 **50 灵玉**。编辑已有纪念日不消耗灵玉。

---

### 5. 主线转支线

将主线任务降级为支线任务固定消耗 **50 灵玉**。

---

### 6. AI 对话消耗

与 AI 助手对话按 token 计费：

| 项目 | 数值 |
|------|------|
| 计费单位 | 每 3000 tokens |
| 单次扣费 | 5 灵玉 |
| 最低余额要求 | 5 灵玉（否则无法发起对话） |

**消耗规则**：
- 累计计算 completionTokens
- 每累计 3000 tokens 扣除 5 灵玉
- 超过 3000 时随机触发扣减（避免固定点扣费）
- 余额不足 5 灵玉时扣除剩余全部
- 余额为 0 时无法发起新对话

---

## 积分上限机制

为防止刷分行为，系统设置了每日积分上限：

### 每日上限计算

```
灵玉每日上限 = 20 × 打卡类型系数 × 任务类型系数
修为每日上限 = 10 × 打卡类型系数 × 任务类型系数
```

### 上限范围示例

| 任务类型 | 打卡类型 | 灵玉上限 | 修为上限 |
|---------|---------|---------|---------|
| 支线任务 + 次数类 | 最低 | 20 | 10 |
| 支线任务 + 数量类 | 中等 | 22 | 11 |
| 支线任务 + 时长类 | 较高 | 23 | 11 |
| 主线任务 + 次数类 | 高 | 40 | 20 |
| 主线任务 + 时长类 | 最高 | 46 | 23 |

---

## 折扣与优惠

### 新手优惠

| 场景 | 折扣 |
|------|------|
| 首个主线任务（归档无主线 + 当前无主线） | 免费 |
| 首个支线任务（归档无支线 + 当前无支线） | 免费 |

### 回归优惠

| 场景 | 折扣 |
|------|------|
| 主线回归（归档有主线 + 当前无主线 + 当前无支线） | 50% 折扣 |
| 支线回归（归档有支线 + 当前无支线） | 80% 折扣 |

---

## 灵玉与修为的关系

系统同时存在两种积分类型：

| 类型 | 说明 | 基础值 | 用途 |
|------|------|--------|------|
| 灵玉 | 可消耗货币 | 20/天 | 创建任务、刷新清单等 |
| 修为 | 累计成长值 | 10/天 | 等级成长、成就系统 |

两者通常同步获取，但只有灵玉可以消耗使用，修为只增不减。

---

## 数据查看与管理

### 灵玉明细页面

路径：设置 → 灵玉明细

显示内容：
- 当前余额
- 累计获得
- 累计消耗
- 变动记录列表（按时间倒序）

### 变动记录类型

| 类型 | 来源标识 |
|------|---------|
| 打卡获取 | CHECK_IN |
| 今日必完成加成 | MUST_COMPLETE_BONUS |
| 周期完成奖励 | CYCLE_COMPLETE |
| 一日清单完成 | DAILY_COMPLETE |
| 归档奖励 | ARCHIVE |
| 创建任务消耗 | CREATE_TASK |
| 刷新清单消耗 | REFRESH_DAILY |
| AI 对话消耗 | AI_CHAT |

### 调试功能

开发模式下可通过调试页面进行灵玉操作：
- 快捷增减：+100 / +500 / +1000 / -100 / 归零
- 直接设置数量
- 清理历史记录

---

## 设计理念

灵玉系统的设计遵循以下原则：

1. **激励导向**：通过完成任务获取灵玉，鼓励用户坚持执行计划
2. **成本约束**：消耗机制避免滥用功能，如频繁刷新、过度创建任务
3. **渐进平衡**：每日上限防止刷分，消耗与获取保持动态平衡
4. **新手友好**：初始赠送 1000 灵玉 + 首任务免费，降低上手门槛
5. **回归激励**：针对回归用户提供折扣，鼓励重新使用

---

## 相关文件

| 类别 | 文件路径 |
|------|---------|
| 类型定义 | `src/pages/dc/types/spiritJade.ts` |
| 常量配置 | `src/pages/dc/constants/spiritJade.ts` |
| 计算工具 | `src/pages/dc/utils/spiritJadeCalculator.ts` |
| Context Provider | `src/pages/dc/contexts/CultivationProvider/index.tsx` |
| 数据存储 | `src/pages/dc/contexts/CultivationProvider/storage.ts` |
| 明细页面 | `src/pages/dc/viewmodel/SpiritJadePage/index.tsx` |
| 规格文档 | `openspec/specs/spirit-jade-system/spec.md` |

---

*文档版本：v1.0*
*最后更新：2026-01-25*
