# ziwei-panel Specification

## Purpose

紫微斗数命盘面板，提供基于出生时间的命盘排盘和 AI 智能解读功能。作为 DC 模块的独立功能入口，融合传统命理学与现代 AI 技术，提供专业且有趣的命理分析体验。

## ADDED Requirements

### Requirement: 4步页面流程

系统 **SHALL** 提供4步式页面流程，与创建任务弹窗样式一致。

#### Scenario: 第1步介绍页

- **GIVEN** 用户打开紫微命盘面板
- **WHEN** 面板渲染完成
- **THEN** 显示动态展示命盘特点的介绍
- **AND** 显示“开始排盘”按钮

#### Scenario: 第2步输入页

- **GIVEN** 用户点击“开始排盘”
- **WHEN** 进入输入页
- **THEN** 显示出生信息表单（日期类型、出生日期时间、城市、性别）
- **AND** 填写完整后启用“生成命盘”按钮

#### Scenario: 第3步结果页

- **GIVEN** 用户点击“生成命盘”
- **WHEN** 命盘计算完成
- **THEN** 显示命盘图（仅概览不可点）
- **AND** 显示Tab分类报告（财运/感情/事业）
- **AND** 显示“保存命盘”和“AI分析”按钮

#### Scenario: 第4步AI分析页

- **GIVEN** 用户点击“AI分析”
- **WHEN** 进入AI分析页
- **THEN** 显示AI对话界面
- **AND** 命盘数据作为系统提示词注入

### Requirement: 出生信息输入

系统 **SHALL** 提供完整的出生信息输入表单，收集排盘所需的基础数据。

#### Scenario: 用户输入完整出生信息

- **GIVEN** 用户打开紫微命盘面板
- **WHEN** 用户填写年、月、日、时、分、城市和性别
- **THEN** 表单验证所有必填字段
- **AND** 验证通过后启用"生成命盘"按钮

#### Scenario: 表单数据校验

- **GIVEN** 用户正在填写出生信息
- **WHEN** 用户输入无效数据（如月份超过12、日期超过31等）
- **THEN** 系统显示对应的错误提示
- **AND** 阻止表单提交

#### Scenario: 记忆上次输入

- **GIVEN** 用户之前填写过出生信息
- **WHEN** 用户再次打开面板
- **THEN** 表单自动填充上次输入的信息

### Requirement: 真太阳时校正

系统 **SHALL** 根据出生城市的经纬度，对出生时间进行真太阳时校正。

#### Scenario: 根据城市校正时间

- **GIVEN** 用户选择了出生城市
- **WHEN** 系统计算命盘
- **THEN** 根据城市经度计算时差
- **AND** 应用真太阳时校正到出生时间

#### Scenario: 显示校正结果

- **GIVEN** 系统完成真太阳时校正
- **WHEN** 命盘生成完成
- **THEN** 在命盘中显示校正后的时间

### Requirement: 命盘计算

系统 **SHALL** 根据出生信息计算完整的紫微斗数命盘。

#### Scenario: 计算十二宫位

- **GIVEN** 用户提交了有效的出生信息
- **WHEN** 系统生成命盘
- **THEN** 计算命宫所在宫位
- **AND** 依次确定兄弟、夫妻、子女、财帛、疾厄、迁移、交友、事业、田宅、福德、父母各宫

#### Scenario: 分配星曜

- **GIVEN** 十二宫位计算完成
- **WHEN** 系统分配星曜
- **THEN** 将十四主星分配到对应宫位
- **AND** 将辅星分配到对应宫位
- **AND** 将四化星（禄权科忌）分配到对应宫位

### Requirement: 命盘可视化

系统 **SHALL** 以传统十二宫格局展示命盘数据（仅概览不可点）。

#### Scenario: 展示十二宫格局

- **GIVEN** 命盘数据计算完成
- **WHEN** 用户查看命盘
- **THEN** 以 4x4 网格展示十二宫（中央为基本信息）
- **AND** 每个宫位显示宫名、地支、主星、辅星、四化
- **AND** 宫位仅作概览展示，不支持点击交互

#### Scenario: 星曜颜色区分

- **GIVEN** 命盘展示中
- **WHEN** 显示各类星曜
- **THEN** 主星使用金色
- **AND** 辅星使用蓝色
- **AND** 化禄显示绿色、化权显示红色、化科显示蓝色、化忌显示灰色

### Requirement: 格式化分析报告

系统 **SHALL** 提供基于命盘的Tab分类分析报告（财运/感情/事业）。

#### Scenario: Tab分类展示

- **GIVEN** 命盘生成完成
- **WHEN** 用户查看结果页
- **THEN** 默认显示财运分析Tab
- **AND** 可切换查看感情分析、事业分析

#### Scenario: 财运分析Tab

- **GIVEN** 用户切换到“财运”Tab
- **WHEN** Tab内容显示
- **THEN** 显示财帜宫分析、财富潜力评估、理财建议

#### Scenario: 感情分析Tab

- **GIVEN** 用户切换到“感情”Tab
- **WHEN** Tab内容显示
- **THEN** 显示夫妻宫分析、婚姻特质、恋爱时机预测

#### Scenario: 事业分析Tab

- **GIVEN** 用户切换到“事业”Tab
- **WHEN** Tab内容显示
- **THEN** 显示官禄宫分析、事业格局、贵人助力分析

### Requirement: AI 对话分析

系统 **SHALL** 支持用户与 AI 进行基于命盘的自由对话，每次消耗 100 灵玉。

#### Scenario: 打开 AI 对话

- **GIVEN** 命盘已生成
- **WHEN** 用户点击“AI分析”按钮
- **THEN** 进入第4步AI分析页
- **AND** AI 以专业严谨的命理分析师角色与用户对话
- **AND** 命盘数据作为系统提示词注入

#### Scenario: AI 分析风格

- **GIVEN** 用户在 AI 对话中提问
- **WHEN** AI 生成回复
- **THEN** 回复基于紫微斗数经典理论
- **AND** 引用具体的星曜组合作为依据
- **AND** 语言风格既专业又易懂

#### Scenario: AI 消耗灵玉

- **GIVEN** 用户发起 AI 对话
- **WHEN** AI 生成回复
- **THEN** 每次对话消耗 100 灵玉
- **AND** 灵玉不足时显示灵玉不足弹窗

### Requirement: 数据持久化

系统 **SHALL** 支持手动保存命盘数据到本地（仅保存最近一次）。

#### Scenario: 手动保存命盘

- **GIVEN** 用户生成了命盘
- **WHEN** 用户点击“保存命盘”按钮
- **THEN** 将出生信息和命盘数据保存到 localStorage
- **AND** 显示保存成功 Toast

#### Scenario: 恢复命盘数据

- **GIVEN** 用户之前保存过命盘
- **WHEN** 用户再次打开面板
- **THEN** 自动加载上次保存的命盘
- **AND** 跳过介绍页直接显示结果页

#### Scenario: 重新排盘

- **GIVEN** 用户有已保存的命盘数据
- **WHEN** 用户点击“重新排盘”
- **THEN** 返回输入页（第2步）
- **AND** 保留上次填写的出生信息作为默认值

### Requirement: 视觉风格

系统 **SHALL** 完全复用创建任务弹窗样式（白色背景、简约风格）。

#### Scenario: 面板整体风格

- **GIVEN** 用户打开紫微命盘面板
- **WHEN** 面板渲染完成
- **THEN** 样式与创建任务弹窗一致
- **AND** 使用相同的分步指示器、头部样式、表单样式

#### Scenario: 命盘宫位样式

- **GIVEN** 命盘展示中
- **WHEN** 显示各宫位
- **THEN** 宫位使用简约卡片样式
- **AND** 保持与整体风格一致
