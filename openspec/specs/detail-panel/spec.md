# detail-panel Specification

## Purpose

任务详情页（Detail Panel）是任务管理的核心交互界面，采用单屏聚焦设计，突出「今日进度」和「周期进展」两个核心区域，提供清爽简约的操作体验。

## Design Principles

### 视觉风格
- **色系**：浅系简约风格，与设置面板保持一致
- **高亮色**：渐变色 `linear-gradient(135deg, #667eea, #764ba2)`（今日毕配色）
- **背景色**：`#F5F5F7`（Off-white）
- **卡片背景**：`#FFFFFF`（纯白）
- **主文字**：`#1D1D1F`
- **次要文字**：`rgba(55, 53, 47, 0.5)`
- **卡片圆角**：16px
- **卡片阴影**：`0 2px 8px rgba(0, 0, 0, 0.04)`

### 布局结构
- **单屏不滚动**：所有核心内容一屏展示
- **层级分明**：今日进度 > 周期进展 > 二级入口

---
## Requirements
### Requirement: 页面整体布局

系统 **SHALL** 采用单屏聚焦布局，从上到下依次为：顶部栏、今日进度卡片、周期进展卡片、二级入口。

#### Scenario: 页面结构

**GIVEN** 用户打开任务详情页
**WHEN** 页面加载完成
**THEN** 页面从上到下显示：
- 顶部栏（48px）：关闭按钮、任务标题、更多操作按钮
- 今日进度卡片：根据任务类型展示不同视觉
- 周期进展卡片：条形进度条
- 二级入口：横向排列「记录」「计划」两个入口
- SafeArea 底部安全区

---

### Requirement: 顶部栏设计

系统 **SHALL** 提供简洁的顶部栏，包含关闭、标题和更多操作。

#### Scenario: 顶部栏元素

**GIVEN** 详情页显示
**WHEN** 查看顶部栏
**THEN** 显示：
- 左侧：关闭按钮（×），颜色 `rgba(55, 53, 47, 0.5)`
- 中间：任务标题，16px，字重 500，单行截断
- 右侧：更多按钮（···）

#### Scenario: 更多操作菜单

**GIVEN** 用户点击更多按钮（···）
**WHEN** 菜单弹出
**THEN** 显示 ActionSheet，包含：
- 编辑任务
- 提前结束
- 转为支线（占位，显示"功能开发中"）

---

### Requirement: CHECK_IN 类型 - 咖啡杯视觉

系统 **SHALL** 为打卡型任务使用咖啡杯水位隐喻展示进度。

#### Scenario: 咖啡杯布局

**GIVEN** 任务类型为 CHECK_IN
**WHEN** 显示今日进度卡片
**THEN** 显示：
- 中心：咖啡杯图形，水位高度 = 周期完成度
- 水位下方：今日进度条
- 杯子下方：打卡按钮

#### Scenario: 水位动画

**GIVEN** 用户完成打卡
**WHEN** 打卡成功
**THEN** 
- 今日进度条增长动画
- 咖啡杯水位上涨动画
- 触发 confetti 彩纸效果

#### Scenario: TIMES 类型显示

**GIVEN** CHECK_IN 单位为 TIMES
**WHEN** 显示今日进度
**THEN** 显示「今日 X 次」，按钮文案「立即打卡」

#### Scenario: DURATION 类型显示

**GIVEN** CHECK_IN 单位为 DURATION
**WHEN** 显示今日进度
**THEN** 显示「今日 X 分钟」，按钮文案「记录时长」

#### Scenario: QUANTITY 类型显示

**GIVEN** CHECK_IN 单位为 QUANTITY
**WHEN** 显示今日进度
**THEN** 显示「今日 X 个」，按钮文案「记录数值」

#### Scenario: 今日已完成状态

**GIVEN** 今日打卡已完成目标
**WHEN** 显示打卡按钮
**THEN** 按钮变灰，文案「今日已完成」

---

### Requirement: NUMERIC 增加型 - 杯子注水视觉

系统 **SHALL** 为数值增加型任务使用杯子注水隐喻。

#### Scenario: 注水杯布局

**GIVEN** 任务类型为 NUMERIC 且方向为增加（INCREASE）
**WHEN** 显示今日进度卡片
**THEN** 显示：
- 中心：杯子图形，水位高度 = (当前值 - 起始值) / (目标值 - 起始值)
- 杯子内显示当前数值 + 单位
- 杯子下方：趋势指示（↑ X 较昨日）
- 底部：「记录新数据」按钮

#### Scenario: 注水动画

**GIVEN** 用户记录新数据
**WHEN** 数据保存成功
**THEN** 水位上涨动画，水滴落入效果

---

### Requirement: NUMERIC 减少型 - 冰块融化视觉

系统 **SHALL** 为数值减少型任务使用冰块融化隐喻。

#### Scenario: 冰块布局

**GIVEN** 任务类型为 NUMERIC 且方向为减少（DECREASE）
**WHEN** 显示今日进度卡片
**THEN** 显示：
- 中心：冰块图形，冰块大小 = 剩余比例（目标越近，冰块越小）
- 冰块下方：水滴/融化效果（已完成部分）
- 冰块内/旁显示当前数值 + 单位
- 趋势指示（↓ X 较昨日）
- 底部：「记录新数据」按钮

#### Scenario: 融化动画

**GIVEN** 用户记录新数据且数值减少
**WHEN** 数据保存成功
**THEN** 冰块缩小动画，水滴滴落效果

#### Scenario: 融化进度计算

**GIVEN** 起始值 80，目标值 70，当前值 72.5
**WHEN** 计算融化进度
**THEN** 融化进度 = (80 - 72.5) / (80 - 70) = 75%

---

### Requirement: CHECKLIST 类型 - 清单列表

系统 **SHALL** 为清单型任务展示可操作的当前周期清单列表，支持打勾完成、添加和延后操作。

#### Scenario: 清单页面布局

**GIVEN** 任务类型为 CHECKLIST
**WHEN** 显示详情页
**THEN** 显示：
- 不显示 WaterCupProgress 组件（无咖啡杯/水杯）
- 直接展示当前周期清单列表
- 标题行：「本周期清单 X/Y」
- 清单列表末尾：「+ 加入更多清单...」入口
- 保留 CycleInfo 周期进展卡片（与其他任务类型一致）

#### Scenario: 清单项布局

**GIVEN** 渲染清单列表
**WHEN** 显示每个清单项
**THEN**
- 已完成项：勾选状态 + 删除线 + 颜色变淡
- 未完成项：空勾选框 + 支持右滑操作
- 每项高度至少 48px，便于触控操作
- 勾选框点击区域足够大，避免误触

#### Scenario: 清单项周期分配逻辑

**GIVEN** 创建清单类型任务时设定了总清单数和总周期数
**WHEN** 系统分配清单项到各周期
**THEN** 默认平均分配到每个周期

#### Scenario: 未完成清单项延续

**GIVEN** 当前周期结束时有未完成的清单项
**WHEN** 进入下一周期
**THEN** 未完成项自动延续到下一周期
**And** 下一周期的清单项 = 延续项 + 原计划平均分配项

#### Scenario: 清单项打勾完成

**GIVEN** 用户点击未完成的清单项勾选框
**WHEN** 点击成功
**THEN** 
- 该项变为已完成状态
- 标题行进度更新
- 触发成功 Toast
- 发放相应奖励（如未超限）

#### Scenario: 清单项右滑操作

**GIVEN** 用户在未完成的清单项上左滑
**WHEN** 滑动距离超过阈值
**THEN** 显示「移到下周期」操作按钮（橙色背景）

#### Scenario: 清单项延后二次确认

**GIVEN** 用户点击「移到下周期」按钮
**WHEN** 弹窗打开
**THEN** 显示支线区域风格的确认弹窗
**And** 弹窗内容：
- 标题：「移到下周期」
- 描述：「『XXX』将移至下一周期」
- 提示：「本操作需消耗 2 灵玉」
- 按钮：「取消」、「确认 💎2」

#### Scenario: 确认延后操作

**GIVEN** 用户在确认弹窗点击「确认」
**WHEN** 用户灵玉余额 >= 2
**THEN** 
- 扣除 2 灵玉
- 该清单项从当前周期移除
- 标记为下一周期待完成
- 显示成功 Toast

#### Scenario: 延后灵玉不足

**GIVEN** 用户在确认弹窗点击「确认」
**WHEN** 用户灵玉余额 < 2
**THEN** 显示灵玉不足提示弹窗

#### Scenario: 加入更多清单项入口

**GIVEN** 用户点击「+ 加入更多清单...」
**WHEN** 弹窗打开
**THEN** 显示非当前周期、未完成的清单项列表
**And** 每项可点击加入（消耗 1 灵玉）

#### Scenario: 加入清单项到当前周期

**GIVEN** 用户在「加入更多」弹窗中点击某清单项
**WHEN** 用户灵玉余额 >= 1
**THEN**
- 弹出二次确认：「加入『XXX』到当前周期，消耗 1 灵玉」
- 确认后扣除 1 灵玉
- 该清单项添加到当前周期
- 弹窗列表更新
- 显示成功 Toast

#### Scenario: 加入时灵玉不足

**GIVEN** 用户在「加入更多」弹窗中点击某清单项
**WHEN** 用户灵玉余额 < 1
**THEN** 显示灵玉不足提示弹窗

---

### Requirement: 周期进展卡片

系统 **SHALL** 展示当前周期的进度信息。

#### Scenario: 周期进展布局

**GIVEN** 详情页显示
**WHEN** 查看周期进展卡片
**THEN** 显示：
- 标题：「周期进展」（14px，次要色）
- 信息行：「第 X/Y 周期 · 剩余 Z 天」（13px）
- 进度条：条形进度条，高度 8px，圆角 4px
- 进度条右侧：「已完成/目标」数字

#### Scenario: 进度条样式

**GIVEN** 显示进度条
**WHEN** 渲染进度条
**THEN** 
- 轨道背景：`#E8E8E8`
- 填充色：主题渐变色
- 填充宽度 = 周期完成度百分比

---

### Requirement: 二级入口

系统 **SHALL** 提供简约的二级页面入口。

#### Scenario: 二级入口布局

**GIVEN** 详情页显示
**WHEN** 查看二级入口区域
**THEN** 显示横向排列的两个入口：
- 「记录」：点击进入打卡记录页
- 「计划」：点击进入周期计划页

#### Scenario: 入口样式

**GIVEN** 显示二级入口
**WHEN** 渲染入口按钮
**THEN** 
- 白色卡片背景
- 圆角 12px
- 等宽布局
- 高度 48px
- 文字 14px，居中

#### Scenario: 进入记录页

**GIVEN** 用户点击「记录」入口
**WHEN** 页面跳转
**THEN** 打开全屏 Popup，显示 CheckInHistoryPanel 内容

#### Scenario: 进入计划页

**GIVEN** 用户点击「计划」入口
**WHEN** 页面跳转
**THEN** 打开全屏 Popup，显示 HistoryCyclePanel 内容

---

### Requirement: 已结束任务状态

系统 **SHALL** 为已结束的任务提供特殊的完成状态展示。

#### Scenario: 已结束任务布局

**GIVEN** 任务 isPlanEnded = true
**WHEN** 显示今日进度卡片
**THEN** 显示：
- 状态文字：「计划已完成 🎉」
- 汇总信息：「共完成 X 次打卡」
- 底部按钮：「归档总结」（渐变色）

#### Scenario: 已结束周期进展

**GIVEN** 任务 isPlanEnded = true
**WHEN** 显示周期进展卡片
**THEN** 信息行显示「第 X/Y 周期 · 已结束」

#### Scenario: 归档操作

**GIVEN** 用户点击「归档总结」按钮
**WHEN** 归档成功
**THEN** 
- 显示成功 Toast
- 关闭详情页
- 任务状态变为 ARCHIVED

---

### Requirement: 交互动画

系统 **SHALL** 提供流畅的交互动画效果。

#### Scenario: 打卡成功动画

**GIVEN** 用户完成打卡或记录
**WHEN** 操作成功
**THEN** 
- 触发 confetti 彩纸效果
- 进度条/水位平滑过渡（300ms ease-out）
- 显示成功 Toast

#### Scenario: 卡片出现动画

**GIVEN** 详情页打开
**WHEN** 内容加载完成
**THEN** 卡片依次 fade-in（200ms）

#### Scenario: 按钮点击反馈

**GIVEN** 用户点击按钮
**WHEN** 按下按钮
**THEN** 按钮 scale 0.98 → 1.0（150ms）

---

### Requirement: 响应式适配

系统 **SHALL** 适配不同屏幕尺寸的移动设备。

#### Scenario: 小屏幕适配

**GIVEN** 屏幕高度较小（< 667px）
**WHEN** 显示详情页
**THEN** 
- 今日进度卡片适当缩小
- 保持核心信息可见
- 不出现滚动条

#### Scenario: 安全区域

**GIVEN** 设备有底部安全区域
**WHEN** 显示详情页
**THEN** 底部留出 SafeArea 空间

---

### Requirement: 归档任务只读详情页

系统 **SHALL** 支持打开归档任务的完整详情页，采用只读模式展示。

#### Scenario: 打开归档任务详情

**GIVEN** 用户在归档列表页点击某个归档任务
**WHEN** 详情页打开
**THEN** 显示 GoalDetailModal
**And** 传入 isReadOnly=true

#### Scenario: 只读模式隐藏操作元素

**GIVEN** GoalDetailModal 以 isReadOnly=true 打开
**WHEN** 页面渲染
**THEN** 隐藏以下元素：
- 底部打卡/记录按钮
- 顶部更多菜单中的「编辑」「提前结束」「转为支线」选项

#### Scenario: 只读模式保留查看入口

**GIVEN** GoalDetailModal 以 isReadOnly=true 打开
**WHEN** 页面渲染
**THEN** 保留以下入口：
- 「记录」入口（查看历史打卡记录）
- 「计划」入口（查看周期计划）
- 周期进展信息展示
- 今日进度信息展示

---

### Requirement: 主线任务转支线任务

系统 **SHALL** 支持将主线任务转换为支线任务。

#### Scenario: 显示转为支线选项

**GIVEN** 用户打开主线任务（type='mainline'）的详情页
**WHEN** 点击右上角更多按钮
**THEN** 菜单中显示「转为支线」选项

#### Scenario: 支线任务不显示转换选项

**GIVEN** 用户打开支线任务的详情页
**WHEN** 点击右上角更多按钮
**THEN** 菜单中不显示「转为支线」选项

#### Scenario: 转换确认弹窗

**GIVEN** 用户点击「转为支线」选项
**WHEN** 弹窗打开
**THEN** 显示支线区域风格的确认弹窗
**And** 提示「将消耗 50 灵玉」
**And** 显示「确认」和「取消」按钮

#### Scenario: 确认转换

**GIVEN** 用户在确认弹窗点击「确认」
**WHEN** 用户灵玉余额 >= 50
**THEN**
- 扣除 50 灵玉
- 任务 type 改为 'sidelineA'
- 保留所有其他数据（周期、进度等）
- 关闭详情页
- 显示成功 Toast

#### Scenario: 转换灵玉不足

**GIVEN** 用户在确认弹窗点击「确认」
**WHEN** 用户灵玉余额 < 50
**THEN** 显示灵玉不足提示弹窗
**And** 不执行转换

## Component Structure

### 新建组件

| 组件名 | 说明 |
|--------|------|
| `TodayProgressCard` | 今日进度卡片，根据任务类型分化展示 |
| `CoffeeCupProgress` | CHECK_IN 咖啡杯水位组件 |
| `WaterCupProgress` | NUMERIC 增加型杯子注水组件 |
| `IceMeltProgress` | NUMERIC 减少型冰块融化组件 |
| `ChecklistProgress` | CHECKLIST 清单列表组件 |
| `CycleProgressCard` | 周期进展卡片 |
| `SecondaryNav` | 二级入口导航 |

### 复用组件

| 组件名 | 复用方式 |
|--------|----------|
| `CheckInModal` | 打卡输入弹窗，保持不变 |
| `RecordDataModal` | 数值记录弹窗，保持不变 |
| `CheckInHistoryPanel` | 作为「记录」二级页内容 |
| `HistoryCyclePanel` | 作为「计划」二级页内容 |
| `SidelineTaskEditModal` | 编辑弹窗，保持不变 |

---

## Visual Reference

### CHECK_IN 咖啡杯

```
┌─────────────────────────────────────┐
│                                     │
│         ┌─────────────┐            │
│         │   ██████    │ ← 周期水位 │
│         │   ██████    │            │
│         │   ░░░░░░    │            │
│         └──────┬──────┘            │
│                                     │
│    ━━━━━━━━━━━●━━━━━━━━━━━         │ ← 今日进度
│         今日 2/3 次                 │
│                                     │
│    ┌───────────────────────────┐   │
│    │      ✓ 立即打卡            │   │
│    └───────────────────────────┘   │
└─────────────────────────────────────┘
```

### NUMERIC 增加型（杯子注水）

```
┌─────────────────────────────────────┐
│                                     │
│         ┌─────────────┐            │
│         │   ██████    │            │
│         │   ██████    │ 7500 元    │
│         │   ░░░░░░    │            │
│         └─────────────┘            │
│              💧                     │
│           ↑ 500 较昨日              │
│                                     │
│    ┌───────────────────────────┐   │
│    │      记录新数据            │   │
│    └───────────────────────────┘   │
└─────────────────────────────────────┘
```

### NUMERIC 减少型（冰块融化）

```
┌─────────────────────────────────────┐
│                                     │
│           ┌─────┐                  │
│           │░░░░░│ 72.5 kg          │ ← 冰块
│           └─────┘                  │
│            💧💧💧                   │ ← 融化水滴
│                                     │
│           ↓ 0.5 较昨日              │
│         融化进度 75%                │
│                                     │
│    ┌───────────────────────────┐   │
│    │      记录新数据            │   │
│    └───────────────────────────┘   │
└─────────────────────────────────────┘
```

### CHECKLIST 清单

```
┌─────────────────────────────────────┐
│           本周期清单   2/5          │
│  ┌───────────────────────────────┐ │
│  │ ✓ 完成设计稿                  │ │
│  │ ✓ 开发前端页面                │ │
│  │ ○ 编写测试用例                │ │
│  │ ○ 代码评审                    │ │
│  │ ○ 部署上线                    │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

---
